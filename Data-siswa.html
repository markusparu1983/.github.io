<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Siswa - Sistem Raport Digital</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- PDF Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Excel Export Library -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <!-- Include CSS File -->
  <?!= include('css'); ?>
</head>
<body>
  <!-- Include Sidebar -->
  <?!= include('sidebar'); ?>

  <!-- Loading Indicator -->
  <div id="loading-indicator">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-center">Memuat data...</p>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Header Section -->
    <header class="header fade-in">
      <h4 id="content-title">Data Siswa</h4>
      <div class="user-info">
        <img src="https://res.cloudinary.com/di10axon3/image/upload/v1747889808/DSC_4881_tnwbnj.jpg" 
        alt="User Avatar" 
        class="user-avatar" />
          <div>
          <div id="user-name">Admin</div>
          <small id="user-role" class="text-muted">Markus paru</small>
        </div>
    </header>

    <!-- Data Siswa Content -->
    <div class="card fade-in">
      <div class="card-body">
        <div class="data-tools">
          <div class="input-group" style="max-width: 300px;">
            <input type="text" id="search-input" class="form-control" placeholder="Cari siswa..." 
                   onkeypress="handleSearchKeyPress(event)" aria-label="Cari siswa">
            <button class="btn btn-primary" type="button" onclick="searchStudents()" aria-label="Cari">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="showAddStudentModal()" aria-label="Tambah siswa">
              <i class="fas fa-plus me-1"></i> Tambah Siswa
            </button>
            <div class="export-btn-group">
              <button class="btn btn-info export-btn excel" onclick="exportToExcel()" aria-label="Export ke Excel">
                <i class="fas fa-file-excel"></i> Excel
              </button>
              <button class="btn btn-danger export-btn pdf" onclick="exportToPDF()" aria-label="Export ke PDF">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
            <button class="btn btn-outline-secondary" onclick="refreshData()" title="Refresh Data" aria-label="Refresh">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        
        <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>No</th>
                <th>Nama Siswa</th>
                <th>Jenis Kelamin</th>
                <th>Tempat Lahir</th>
                <th>Tanggal Lahir</th>
                <th>Agama</th>
                <th>NISN</th>
                <th>Kelas</th>
                <th>Nama Ibu Kandung</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="students-data">
              <tr>
                <td colspan="10" class="text-center py-4">
                  <i class="fas fa-spinner fa-spin me-2 loading-spinner"></i>Memuat data siswa...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <span class="text-muted" id="student-count">Memuat data...</span>
            <span class="ms-2 text-muted" id="last-updated"></span>
          </div>
          <nav aria-label="Navigasi data siswa">
            <ul class="pagination mb-0" id="pagination">
              <!-- Pagination akan diisi oleh JavaScript -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Modal -->
  <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Tambah Siswa Baru</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalBody">
         <form id="studentForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nama" required maxlength="100" aria-required="true">
              <div class="invalid-feedback">Harap isi nama lengkap</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="nisn" class="form-label">NISN <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nisn" required pattern="\d{10}" 
                     title="NISN harus 10 digit angka" maxlength="10" aria-required="true">
              <div class="invalid-feedback">NISN harus 10 digit angka</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="jenis-kelamin" class="form-label">Jenis Kelamin <span class="text-danger">*</span></label>
              <select class="form-select" id="jenis-kelamin" required aria-required="true">
                <option value="">Pilih Jenis Kelamin</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
              <div class="invalid-feedback">Harap pilih jenis kelamin</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="kelas" class="form-label">Kelas <span class="text-danger">*</span></label>
              <select class="form-select" id="kelas" required aria-required="true">
                <option value="">Pilih Kelas</option>
                <option value="1">Kelas 1</option>
                <option value="2">Kelas 2</option>
                <option value="3">Kelas 3</option>
                <option value="4">Kelas 4</option>
                <option value="5">Kelas 5</option>
                <option value="6">Kelas 6</option>
              </select>
              <div class="invalid-feedback">Harap pilih kelas</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="tempat-lahir" class="form-label">Tempat Lahir <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="tempat-lahir" required maxlength="50" aria-required="true">
              <div class="invalid-feedback">Harap isi tempat lahir</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="tanggal-lahir" class="form-label">Tanggal Lahir <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="tanggal-lahir" required 
                    min="2005-01-01" max="${new Date().toISOString().split('T')[0]}" aria-required="true">
              <div class="invalid-feedback">Tanggal lahir tidak valid</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="agama" class="form-label">Agama <span class="text-danger">*</span></label>
              <select class="form-select" id="agama" required aria-required="true">
                <option value="">Pilih Agama</option>
                <option value="Islam">Islam</option>
                <option value="Kristen">Kristen</option>
                <option value="Katolik">Katolik</option>
                <option value="Hindu">Hindu</option>
                <option value="Budha">Budha</option>
                <option value="Konghucu">Konghucu</option>
              </select>
              <div class="invalid-feedback">Harap pilih agama</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="nama-ibu" class="form-label">Nama Ibu Kandung <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nama-ibu" required maxlength="100" aria-required="true">
              <div class="invalid-feedback">Harap isi nama ibu kandung</div>
            </div>
          </div>
        </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="saveStudentBtn" onclick="saveStudent()">
            <span id="saveBtnText">Simpan</span>
            <span id="saveBtnSpinner" class="spinner-border spinner-border-sm d-none"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalTitle">Konfirmasi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationModalBody">
          Apakah Anda yakin ingin menghapus data siswa ini?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Global variables
    let allStudents = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let studentModal = null;
    let confirmationModal = null;
    let currentStudentId = null;
    let studentToDelete = null;
    let filteredStudents = [];
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modals
      studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
      confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      
      // Set up confirmation modal button
      document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (studentToDelete) {
          deleteStudentConfirmed(studentToDelete);
        }
      });
      
      // Initialize real-time validation
      initValidation();
      
      // Load initial data
      refreshData();
    });

    // ==================== UTILITY FUNCTIONS ====================
    function showLoading(show) {
      const loader = document.getElementById('loading-indicator');
      if (loader) loader.style.display = show ? 'block' : 'none';
    }

    function refreshData() {
      showLoading(true);
      loadUserData();
      loadStudentData();
      updateLastUpdatedTime();
    }

    function updateLastUpdatedTime() {
      const now = new Date();
      document.getElementById('last-updated').textContent = 
        `Terakhir diperbarui: ${now.toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        })}`;
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        
        return date.toLocaleDateString('id-ID', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      } catch (e) {
        console.error('Error formatting date:', e);
        return dateString;
      }
    }

    function formatDateForInput(date) {
      if (!date) return '';
      try {
        if (typeof date === 'string') {
          date = new Date(date);
          if (isNaN(date.getTime())) return '';
        }
        return date.toISOString().split('T')[0];
      } catch (e) {
        console.error('Error formatting date for input:', e);
        return '';
      }
    }

    function validateBirthDate(dateString) {
      if (!dateString) return false;
      
      const birthDate = new Date(dateString);
      if (isNaN(birthDate.getTime())) return false;
      
      const minDate = new Date('2005-01-01');
      const currentDate = new Date();
      
      return birthDate >= minDate && birthDate <= currentDate;
    }

    function validateNISN(nisn) {
      return /^\d{10}$/.test(nisn);
    }

    function resetSaveButton() {
      document.getElementById('saveBtnText').textContent = currentStudentId ? 'Simpan Perubahan' : 'Simpan';
      document.getElementById('saveBtnSpinner').classList.add('d-none');
      document.getElementById('saveStudentBtn').disabled = false;
    }

    function initValidation() {
      // Real-time NISN validation
      document.getElementById('nisn').addEventListener('input', function(e) {
        const isValid = validateNISN(e.target.value);
        e.target.classList.toggle('is-invalid', !isValid);
        e.target.classList.toggle('is-valid', isValid && e.target.value.length > 0);
      });
      
      // Real-time date validation
      document.getElementById('tanggal-lahir').addEventListener('change', function(e) {
        const isValid = validateBirthDate(e.target.value);
        e.target.classList.toggle('is-invalid', !isValid);
        e.target.classList.toggle('is-valid', isValid);
      });
      
      // Real-time required field validation
      const requiredFields = ['nama', 'tempat-lahir', 'nama-ibu'];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.addEventListener('input', function(e) {
          const isValid = e.target.value.trim().length > 0;
          e.target.classList.toggle('is-invalid', !isValid);
          e.target.classList.toggle('is-valid', isValid);
        });
      });
      
      // Real-time select validation
      const requiredSelects = ['jenis-kelamin', 'kelas', 'agama'];
      requiredSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.addEventListener('change', function(e) {
          const isValid = e.target.value.length > 0;
          e.target.classList.toggle('is-invalid', !isValid);
          e.target.classList.toggle('is-valid', isValid);
        });
      });
    }

    // ==================== NAVIGATION FUNCTIONS ====================
    function goToPage(page) {
      google.script.run
        .withSuccessHandler(function(url) {
          window.top.location.href = url;
        })
        .withFailureHandler(function(error) {
          console.error('Navigation error:', error);
          showNotification('Gagal navigasi ke halaman', 'error');
        })
        .navigateToPage(page);
    }

    function logout() {
      if (confirm('Anda yakin ingin keluar dari sistem?')) {
        goToPage('login');
      }
    }

    // ==================== DATA LOADING FUNCTIONS ====================
    function loadUserData() {
      google.script.run
        .withSuccessHandler(function(user) {
          document.getElementById('user-name').textContent = user.name || 'Admin';
          document.getElementById('user-role').textContent = user.role || 'Administrator';
          document.getElementById('user-avatar').innerHTML = 
            user.name ? `<span aria-hidden="true">${user.name.charAt(0).toUpperCase()}</span>` : 
            '<i class="fas fa-user" aria-hidden="true"></i>';
        })
        .withFailureHandler(function(error) {
          console.error('Error loading user:', error);
          showNotification('Gagal memuat data pengguna', 'error');
        })
        .getCurrentUser();
    }

    function loadStudentData() {
      const tbody = document.getElementById('students-data');
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center py-4">
            <i class="fas fa-spinner fa-spin me-2 loading-spinner" aria-hidden="true"></i>Memuat data siswa...
          </td>
        </tr>
      `;
      
      google.script.run
        .withSuccessHandler(function(students) {
          allStudents = students;
          filteredStudents = [...students];
          renderStudentTable();
          updateStudentCount(filteredStudents.length);
          updatePagination(filteredStudents.length);
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading students:', error);
          showErrorInTable('Gagal memuat data siswa');
          showNotification('Gagal memuat data siswa', 'error');
          showLoading(false);
        })
        .getStudentData();
    }

    function showErrorInTable(message) {
      const tbody = document.getElementById('students-data');
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center py-4 text-danger">
            <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>${escapeHtml(message)}
          </td>
        </tr>
      `;
    }

    // ==================== TABLE RENDERING FUNCTIONS ====================
    function renderStudentTable() {
      const tbody = document.getElementById('students-data');
      tbody.innerHTML = '';
      
      if (filteredStudents.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-4">
              Tidak ada data siswa yang ditemukan
            </td>
          </tr>
        `;
        return;
      }
      
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredStudents.length);
      const studentsToShow = filteredStudents.slice(startIndex, endIndex);
      
      studentsToShow.forEach((student, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${startIndex + index + 1}</td>
          <td>${escapeHtml(student['Nama Siswa'] || '-')}</td>
          <td>${escapeHtml(student['Jenis Kelamin'] || '-')}</td>
          <td>${escapeHtml(student['Tempat Lahir'] || '-')}</td>
          <td>${formatDate(student['Tanggal Lahir']) || '-'}</td>
          <td>${escapeHtml(student.Agama || '-')}</td>
          <td>${escapeHtml(student.NISN || '-')}</td>
          <td>${escapeHtml(student.Kelas || '-')}</td>
          <td>${escapeHtml(student['Nama Ibu Kandung'] || '-')}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudent('${escapeHtml(student.NISN)}')" aria-label="Lihat detail">
              <i class="fas fa-eye" aria-hidden="true"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="editStudent('${escapeHtml(student.NISN)}')" aria-label="Edit data">
              <i class="fas fa-edit" aria-hidden="true"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteStudent('${escapeHtml(student.NISN)}')" aria-label="Hapus data">
              <i class="fas fa-trash-alt" aria-hidden="true"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ==================== SEARCH & PAGINATION ====================
    function handleSearchKeyPress(e) {
      if (e.key === 'Enter') {
        searchStudents();
      }
    }

    function searchStudents() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredStudents = [...allStudents];
        renderStudentTable();
        updatePagination(filteredStudents.length);
        updateStudentCount(filteredStudents.length);
        currentPage = 1;
        return;
      }
      
      filteredStudents = allStudents.filter(student => 
        (student.NISN && student.NISN.toLowerCase().includes(searchTerm)) ||
        (student['Nama Siswa'] && student['Nama Siswa'].toLowerCase().includes(searchTerm)) ||
        (student.Kelas && student.Kelas.toString().includes(searchTerm)) ||
        (student['Tempat Lahir'] && student['Tempat Lahir'].toLowerCase().includes(searchTerm)) ||
        (student['Nama Ibu Kandung'] && student['Nama Ibu Kandung'].toLowerCase().includes(searchTerm))
      );
      
      currentPage = 1;
      renderStudentTable();
      updatePagination(filteredStudents.length);
      updateStudentCount(filteredStudents.length);
    }

    function updatePagination(totalItems) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      
      const pageCount = Math.ceil(totalItems / rowsPerPage);
      
      if (pageCount <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Sebelumnya">&laquo;</a>`;
      pagination.appendChild(prevLi);
      
      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(pageCount, currentPage + 2);
      
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)" aria-label="Halaman 1">1</a>`;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})" aria-label="Halaman ${i}">${i}</a>`;
        pagination.appendChild(pageLi);
      }
      
      if (endPage < pageCount) {
        if (endPage < pageCount - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pageCount})" aria-label="Halaman ${pageCount}">${pageCount}</a>`;
        pagination.appendChild(lastLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Selanjutnya">&raquo;</a>`;
      pagination.appendChild(nextLi);
    }

    function changePage(page) {
      if (page < 1 || page > Math.ceil(filteredStudents.length / rowsPerPage)) return;
      
      currentPage = page;
      renderStudentTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateStudentCount(count) {
      const start = (currentPage - 1) * rowsPerPage + 1;
      const end = Math.min(start + rowsPerPage - 1, count);
      document.getElementById('student-count').textContent = 
        `Menampilkan ${start}-${end} dari ${count} siswa`;
    }

    // ==================== STUDENT CRUD OPERATIONS ====================
    function showAddStudentModal() {
      currentStudentId = null;
      document.getElementById('modalTitle').textContent = 'Tambah Siswa Baru';
      document.getElementById('studentForm').reset();
      
      // Clear validation states
      document.querySelectorAll('#studentForm input, #studentForm select').forEach(input => {
        input.classList.remove('is-invalid', 'is-valid');
        input.disabled = false;
      });
      
      document.getElementById('saveStudentBtn').style.display = 'block';
      document.getElementById('saveStudentBtn').onclick = saveStudent;
      document.getElementById('saveBtnText').textContent = 'Simpan';
      document.getElementById('saveBtnSpinner').classList.add('d-none');
      
      studentModal.show();
    }

    function viewStudent(nisn) {
      const student = allStudents.find(s => s.NISN === nisn);
      if (!student) {
        showNotification('Data siswa tidak ditemukan', 'error');
        return;
      }
      
      document.getElementById('modalTitle').textContent = `Detail Siswa - ${escapeHtml(student['Nama Siswa'])}`;
      document.getElementById('studentForm').reset();
      
      // Fill form with student data
      document.getElementById('nama').value = escapeHtml(student['Nama Siswa'] || '');
      document.getElementById('nisn').value = escapeHtml(student.NISN || '');
      document.getElementById('jenis-kelamin').value = escapeHtml(student['Jenis Kelamin'] || '');
      document.getElementById('kelas').value = escapeHtml(student.Kelas || '');
      document.getElementById('tempat-lahir').value = escapeHtml(student['Tempat Lahir'] || '');
      document.getElementById('tanggal-lahir').value = student['Tanggal Lahir'] ? formatDateForInput(student['Tanggal Lahir']) : '';
      document.getElementById('agama').value = escapeHtml(student.Agama || '');
      document.getElementById('nama-ibu').value = escapeHtml(student['Nama Ibu Kandung'] || '');
      
      // Disable all inputs
      document.querySelectorAll('#studentForm input, #studentForm select').forEach(input => {
        input.disabled = true;
      });
      
      document.getElementById('saveStudentBtn').style.display = 'none';
      studentModal.show();
    }

    function editStudent(nisn) {
      const student = allStudents.find(s => s.NISN === nisn);
      if (!student) {
        showNotification('Data siswa tidak ditemukan', 'error');
        return;
      }
      
      currentStudentId = nisn;
      document.getElementById('modalTitle').textContent = `Edit Siswa - ${escapeHtml(student['Nama Siswa'])}`;
      document.getElementById('studentForm').reset();
      
      // Fill form with student data
      document.getElementById('nama').value = escapeHtml(student['Nama Siswa'] || '');
      document.getElementById('nisn').value = escapeHtml(student.NISN || '');
      document.getElementById('jenis-kelamin').value = escapeHtml(student['Jenis Kelamin'] || '');
      document.getElementById('kelas').value = escapeHtml(student.Kelas || '');
      document.getElementById('tempat-lahir').value = escapeHtml(student['Tempat Lahir'] || '');
      document.getElementById('tanggal-lahir').value = student['Tanggal Lahir'] ? formatDateForInput(student['Tanggal Lahir']) : '';
      document.getElementById('agama').value = escapeHtml(student.Agama || '');
      document.getElementById('nama-ibu').value = escapeHtml(student['Nama Ibu Kandung'] || '');
      
      // Enable all inputs except NISN (primary key)
      document.querySelectorAll('#studentForm input, #studentForm select').forEach(input => {
        input.disabled = input.id === 'nisn';
        input.classList.remove('is-invalid', 'is-valid');
      });
      
      document.getElementById('saveStudentBtn').style.display = 'block';
      document.getElementById('saveStudentBtn').onclick = saveStudent;
      document.getElementById('saveBtnText').textContent = 'Simpan Perubahan';
      document.getElementById('saveBtnSpinner').classList.add('d-none');
      
      studentModal.show();
    }

    function saveStudent() {
      // Get form data
      const studentData = {
        nama: document.getElementById('nama').value.trim(),
        nisn: document.getElementById('nisn').value.trim(),
        jenis_kelamin: document.getElementById('jenis-kelamin').value,
        kelas: document.getElementById('kelas').value,
        tempat_lahir: document.getElementById('tempat-lahir').value.trim(),
        tanggal_lahir: document.getElementById('tanggal-lahir').value,
        agama: document.getElementById('agama').value,
        nama_ibu: document.getElementById('nama-ibu').value.trim()
      };
      
      // Clear previous errors
      document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
      });

      // Validate
      let isValid = true;
      if (!studentData.nama) {
        document.getElementById('nama').classList.add('is-invalid');
        isValid = false;
      }
      if (!validateNISN(studentData.nisn)) {
        document.getElementById('nisn').classList.add('is-invalid');
        isValid = false;
      }
      if (!studentData.jenis_kelamin) {
        document.getElementById('jenis-kelamin').classList.add('is-invalid');
        isValid = false;
      }
      if (!studentData.kelas) {
        document.getElementById('kelas').classList.add('is-invalid');
        isValid = false;
      }
      if (!studentData.tempat_lahir) {
        document.getElementById('tempat-lahir').classList.add('is-invalid');
        isValid = false;
      }
      if (!validateBirthDate(studentData.tanggal_lahir)) {
        document.getElementById('tanggal-lahir').classList.add('is-invalid');
        isValid = false;
      }
      if (!studentData.agama) {
        document.getElementById('agama').classList.add('is-invalid');
        isValid = false;
      }
      if (!studentData.nama_ibu) {
        document.getElementById('nama-ibu').classList.add('is-invalid');
        isValid = false;
      }
      
      if (!isValid) {
        showNotification('Harap perbaiki semua field yang ditandai', 'error');
        return;
      }
      
      // Show loading state
      const saveBtn = document.getElementById('saveStudentBtn');
      saveBtn.disabled = true;
      const spinner = document.getElementById('saveBtnSpinner');
      spinner.classList.remove('d-none');
      document.getElementById('saveBtnText').textContent = 'Menyimpan...';

      // Prepare success/error handlers
      const successHandler = function() {
        showNotification(
          currentStudentId ? 'Data siswa berhasil diperbarui' : 'Siswa baru berhasil ditambahkan', 
          'success'
        );
        studentModal.hide();
        refreshData();
      };

      const errorHandler = function(error) {
        console.error('Error:', error);
        showNotification(
          `Gagal ${currentStudentId ? 'memperbarui' : 'menambahkan'} data siswa: ${error.message}`,
          'error'
        );
        resetSaveButton();
      };

      // Call server function
      if (currentStudentId) {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(errorHandler)
          .updateStudent(currentStudentId, studentData);
      } else {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(errorHandler)
          .addStudent(studentData);
      }
    }

    function confirmDeleteStudent(nisn) {
      const student = allStudents.find(s => s.NISN === nisn);
      if (!student) {
        showNotification('Data siswa tidak ditemukan', 'error');
        return;
      }
      
      studentToDelete = nisn;
      document.getElementById('confirmationModalBody').innerHTML = `
        <p>Apakah Anda yakin ingin menghapus data siswa berikut?</p>
        <div class="alert alert-warning">
          <strong>Nama:</strong> ${escapeHtml(student['Nama Siswa'])}<br>
          <strong>NISN:</strong> ${escapeHtml(student.NISN)}<br>
          <strong>Kelas:</strong> ${escapeHtml(student.Kelas)}
        </div>
        <p class="text-danger">Aksi ini tidak dapat dibatalkan!</p>
      `;
      
      confirmationModal.show();
    }

    function deleteStudentConfirmed(nisn) {
      confirmationModal.hide();
      showLoading(true);
      
      google.script.run
        .withSuccessHandler(function() {
          showNotification('Data siswa berhasil dihapus', 'success');
          refreshData();
        })
        .withFailureHandler(function(error) {
          console.error('Error deleting student:', error);
          showNotification('Gagal menghapus data siswa: ' + error.message, 'error');
          showLoading(false);
        })
        .deleteStudent(nisn);
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportToExcel() {
      const btn = document.querySelector('.export-btn.excel');
      const originalContent = btn.innerHTML;
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        // Prepare data
        const exportData = filteredStudents.map((student, index) => ({
          'No': (currentPage - 1) * rowsPerPage + index + 1,
          'Nama Siswa': student['Nama Siswa'] || '-',
          'Jenis Kelamin': student['Jenis Kelamin'] || '-',
          'Tempat Lahir': student['Tempat Lahir'] || '-',
          'Tanggal Lahir': formatDate(student['Tanggal Lahir']) || '-',
          'Agama': student.Agama || '-',
          'NISN': student.NISN || '-',
          'Kelas': student.Kelas || '-',
          'Nama Ibu Kandung': student['Nama Ibu Kandung'] || '-'
        }));

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");

        // Export
        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Data_Siswa_${date}.xlsx`);
        
        showNotification('Data berhasil diekspor ke Excel', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Gagal mengekspor ke Excel: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    function exportToPDF() {
      const btn = document.querySelector('.export-btn.pdf');
      const originalContent = btn.innerHTML;
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        
        // Add title
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text('DATA SISWA SD INPRES ENDE 15', 145, 15, { align: 'center' });
        
        // Add date
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.text(`Dicetak pada: ${new Date().toLocaleDateString('id-ID', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })}`, 145, 22, { align: 'center' });
        
        // Prepare data for export
        const headers = [
          'No',
          'Nama Siswa',
          'Jenis Kelamin',
          'Tempat Lahir',
          'Tanggal Lahir',
          'Agama',
          'NISN',
          'Kelas',
          'Nama Ibu Kandung'
        ];
        
        const data = filteredStudents.map((student, index) => [
          (currentPage - 1) * rowsPerPage + index + 1,
          student['Nama Siswa'] || '-',
          student['Jenis Kelamin'] || '-',
          student['Tempat Lahir'] || '-',
          formatDate(student['Tanggal Lahir']) || '-',
          student.Agama || '-',
          student.NISN || '-',
          student.Kelas || '-',
          student['Nama Ibu Kandung'] || '-'
        ]);
        
        // Add table
        doc.autoTable({
          head: [headers],
          body: data,
          startY: 30,
          margin: { left: 10, right: 10 },
          styles: {
            fontSize: 8,
            cellPadding: 3,
            halign: 'left',
            valign: 'middle'
          },
          headStyles: {
            fillColor: [67, 97, 238],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          columnStyles: {
            0: { halign: 'center', cellWidth: 10 }, // No
            1: { cellWidth: 30 }, // Nama Siswa
            2: { cellWidth: 15, halign: 'center' }, // Jenis Kelamin
            3: { cellWidth: 30 }, // Tempat Lahir
            4: { cellWidth: 30 }, // Tanggal Lahir
            5: { cellWidth: 15, halign: 'center' }, // Agama
            6: { cellWidth: 15 }, // NISN
            7: { cellWidth: 10, halign: 'center' }, // Kelas
            8: { cellWidth: 30 } // Nama Ibu Kandung
          }
        });
        
        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.text(`Halaman ${i} dari ${pageCount}`, 280, 200, { align: 'right' });
        }
        
        // Save PDF
        const date = new Date().toISOString().split('T')[0];
        doc.save(`Data_Siswa_${date}.pdf`);
        
        showNotification('Data berhasil diekspor ke PDF', 'success');
      } catch (error) {
        console.error('Error exporting to PDF:', error);
        showNotification('Gagal mengekspor ke PDF: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // ==================== NOTIFICATION SYSTEM ====================
    function showNotification(message, type = 'info') {
      // Remove any existing notifications first
      const existingAlerts = document.querySelectorAll('.alert-notification');
      existingAlerts.forEach(alert => alert.remove());
      
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show alert-notification`;
      notification.role = 'alert';
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2" aria-hidden="true"></i>
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '2000';
        container.style.maxWidth = '350px';
        document.body.appendChild(container);
      }
      
      container.appendChild(notification);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
  </script>
</body>
</html>